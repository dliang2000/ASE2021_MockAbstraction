\section{Motivating Example}
\label{sec:motivating-example}

In this section, we illustrate how our \textsc{MockDetector} tool finds a mock object created within a unit test case. Our tool identifies variables which have been assigned an object flowing from a mock creation site through a forward flow must analysis.

First, we would like to discuss an example to illustrate our motivation for this project. Listing~\ref{lis:mockCall} illustrates a method \textit{addAll()} that is invoked on a mocked object of Type \textsc{Collection<Number>}. To our knowledge, current static analysis tools cannot easily tell the difference between this method invocation on a mocked object and the method invocation on a real object. As a result, a naive static analysis would interpret method invocations on mocked objects as the behaviour being evaluated, when the purpose of the method invocations on mocked objects are intended model behaviours to fulfill dependency, so that the actual object's behaviour can be prroperly tested.

Listing~\ref{lis:direct} shows the unit test case \textit{testSimpleResolution()} in the benchmark byte-buddy-dep (version 1.7.10) where the mock object \textsc{TypeDescription} is created via a direct call to Java mocking library Mockito's \textit{mock(java.lang.class)}. In this example, our \textsc{MockDetector} tool would utilizes Soot~\cite{Vallee-Rai:1999:SJB:781995.782008} to locate the statements that are instances of Assignment Statement with an invoke expression at the right operand. The tool then checks if the method invoked matches with any Java mocking libraries' APIs creating a mock object, by matching the method name, parameter types, and return type (i.e. the method subsignature).  After the verification, it adds the defined variable at the left operand to the generated set of locals that are labelled mustMock.

Meanwhile, Listing~\ref{lis:container} illustrates the unit test case \textit{testEmployeesPaidIntra()} in the micro-benchmark, where the array \textit{employees\_intra}, is holding two mock \textsc{Employee} object. In this example, our tool would first detect Assignment statement containing ArrayRef, and it would gather the locals at the right operand. The tool then check if any of these locals have already been marked as mustMock in the flow, and the tool would mark the definition box of the ArrayRef as arrayMock, meaning the mockiness has propagated to this array. 

\lstset{language=java,
	keywordstyle=\color{blue}\bfseries,
	commentstyle=\color{green},
	stringstyle=\ttfamily\color{red!50!brown},
	showstringspaces=false}â€Ž
\lstset{literate=%
	*{0}{{{\color{red!20!violet}0}}}1
	{1}{{{\color{red!20!violet}1}}}1
	{2}{{{\color{red!20!violet}2}}}1
	{3}{{{\color{red!20!violet}3}}}1
	{4}{{{\color{red!20!violet}4}}}1
	{5}{{{\color{red!20!violet}5}}}1
	{6}{{{\color{red!20!violet}6}}}1
	{7}{{{\color{red!20!violet}7}}}1
	{8}{{{\color{red!20!violet}8}}}1
	{9}{{{\color{red!20!violet}9}}}1
}

\begin{lstlisting}[basicstyle=\ttfamily, caption={This code snippet illustrates an example where a method is invoked on a mocked object in unit test case \textit{addAllForIterable()}},
basicstyle=\scriptsize\ttfamily,language = Java, framesep=4.5mm,
framexleftmargin=1mm,,captionpos=b,label=lis:mockCall]

@Test
public void addAllForIterable() {
// ...
final Collection<Number> c = createMock(Collection.class);
// ...
expect(c.addAll(inputCollection)).andReturn(true);
// ...
}

\end{lstlisting}

\begin{lstlisting}[basicstyle=\ttfamily, caption={This example illustrates a direct call to Mockito's \textit{mock(java.lang.class)} function from test case \textit{testSimpleResolution()}.},
basicstyle=\scriptsize\ttfamily,language = Java, framesep=4.5mm,
framexleftmargin=1mm,,captionpos=b,label=lis:direct]

import static org.mockito.Mockito.mock;

// ...

@Test
public void testSimpleResolution() throws Exception {
TypeDescription typeDescription = 
mock(TypeDescription.class);
// ...
}

\end{lstlisting}

\begin{lstlisting}[basicstyle=\ttfamily, caption={This example illustrates an array container holding mock objects from test case \textit{testEmployeesPaidIntra()}.},
basicstyle=\scriptsize\ttfamily,language = Java, framesep=4.5mm,
framexleftmargin=1mm,,captionpos=b,label=lis:container]

@Test
public void testEmployeesPaidIntra() {
Employee[] employees_intra = new Employee[2];
employees_intra[0] = mock(Employee.class);
employees_intra[1] = mock(Employee.class);
// ...
}

\end{lstlisting}
